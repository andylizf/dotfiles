name: dotfiles

resources:
  cloud: gcp
  disk_size: 50

envs:
  DOTFILES_REPO: https://github.com/andylizf/dotfiles.git

setup: |
  set -euxo pipefail
  if command -v apt-get >/dev/null 2>&1; then
    sudo apt-get update -y
    sudo apt-get install -y curl git
  fi

  if ! command -v nix >/dev/null 2>&1; then
    sh <(curl -L https://nixos.org/nix/install) --no-daemon
  fi

  mkdir -p "$HOME/.config/nix"
  printf '%s\n' "experimental-features = nix-command flakes" > "$HOME/.config/nix/nix.conf"
  . "$HOME/.nix-profile/etc/profile.d/nix.sh" || true

  if [[ -d "$HOME/dotfiles/.git" ]]; then
    git -C "$HOME/dotfiles" fetch origin || true
    if git -C "$HOME/dotfiles" rev-parse --verify remotes/origin/main >/dev/null 2>&1; then
      git -C "$HOME/dotfiles" checkout -B main origin/main
      git -C "$HOME/dotfiles" reset --hard origin/main
    else
      rm -rf "$HOME/dotfiles"
      git clone "$DOTFILES_REPO" "$HOME/dotfiles"
    fi
  else
    git clone "$DOTFILES_REPO" "$HOME/dotfiles"
  fi

  cd "$HOME/dotfiles"
  nix run home-manager/master -- switch --flake .#gcpuser-linux

  # Set fish as login shell using the Nix-installed fish, if present
  FISH_BIN="$HOME/.nix-profile/bin/fish"
  if [ -x "$FISH_BIN" ]; then
    if ! grep -qx "$FISH_BIN" /etc/shells; then
      echo "$FISH_BIN" | sudo tee -a /etc/shells >/dev/null
    fi
    # try with sudo (for managed images) then fallback to self
    sudo chsh -s "$FISH_BIN" "$USER" || chsh -s "$FISH_BIN" || true
  fi

run: |
  set -euxo pipefail
  . "$HOME/.nix-profile/etc/profile.d/nix.sh" || true
  echo "fish: $(fish --version || true)"
  echo "node: $(node -v || true)"
  echo "gh: $(gh --version | head -n1 || true)"
  echo "git user: $(git config --global user.name) <$(git config --global user.email)>"
  echo "PATH: $PATH"
  echo "Done"
